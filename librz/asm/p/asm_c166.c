// SPDX-FileCopyrightText: 2023 Jairus Martin <frmdstryr@protonmail.com>
// SPDX-License-Identifier: LGPL-3.0-only

#include <rz_types.h>
#include <rz_asm.h>

#include "../arch/c166/c166_dis.h"

typedef struct {
    ut8 op;
    ut8 len;
} c166_opcode_size_t;

static c166_opcode_size_t c166_opcode_sizes[] = {
	{0x00, 2},
	{0x01, 2},
	{0x02, 4},
	{0x03, 4},
	{0x04, 4},
	{0x05, 4},
	{0x06, 4},
	{0x07, 4},
	{0x08, 2},
	{0x09, 2},
	{0x0A, 4},
	{0x0B, 2},
	{0x0C, 2},
	{0x0D, 2},
	{0x0E, 2},
	{0x0F, 2},
	{0x10, 2},
	{0x11, 2},
	{0x12, 4},
	{0x13, 4},
	{0x14, 4},
	{0x15, 4},
	{0x16, 4},
	{0x17, 4},
	{0x18, 2},
	{0x19, 2},
	{0x1A, 4},
	{0x1B, 2},
	{0x1C, 2},
	{0x1D, 2},
	{0x1E, 2},
	{0x1F, 2},
	{0x20, 2},
	{0x21, 2},
	{0x22, 4},
	{0x23, 4},
	{0x24, 4},
	{0x25, 4},
	{0x26, 4},
	{0x27, 4},
	{0x28, 2},
	{0x29, 2},
	{0x2A, 4},
	{0x2B, 2},
	{0x2C, 2},
	{0x2D, 2},
	{0x2E, 2},
	{0x2F, 2},
	{0x30, 2},
	{0x31, 2},
	{0x32, 4},
	{0x33, 4},
	{0x34, 4},
	{0x35, 4},
	{0x36, 4},
	{0x37, 4},
	{0x38, 2},
	{0x39, 2},
	{0x3A, 4},
	{0x3B, 0},
	{0x3C, 2},
	{0x3D, 2},
	{0x3E, 2},
	{0x3F, 2},
	{0x40, 2},
	{0x41, 2},
	{0x42, 4},
	{0x43, 4},
	{0x44, 0},
	{0x45, 0},
	{0x46, 4},
	{0x47, 4},
	{0x48, 2},
	{0x49, 2},
	{0x4A, 4},
	{0x4B, 2},
	{0x4C, 2},
	{0x4D, 2},
	{0x4E, 2},
	{0x4F, 2},
	{0x50, 2},
	{0x51, 2},
	{0x52, 4},
	{0x53, 4},
	{0x54, 4},
	{0x55, 4},
	{0x56, 4},
	{0x57, 4},
	{0x58, 2},
	{0x59, 2},
	{0x5A, 4},
	{0x5B, 2},
	{0x5C, 2},
	{0x5D, 2},
	{0x5E, 2},
	{0x5F, 2},
	{0x60, 2},
	{0x61, 2},
	{0x62, 4},
	{0x63, 4},
	{0x64, 4},
	{0x65, 4},
	{0x66, 4},
	{0x67, 4},
	{0x68, 2},
	{0x69, 2},
	{0x6A, 4},
	{0x6B, 2},
	{0x6C, 2},
	{0x6D, 2},
	{0x6E, 2},
	{0x6F, 2},
	{0x70, 2},
	{0x71, 2},
	{0x72, 4},
	{0x73, 4},
	{0x74, 4},
	{0x75, 4},
	{0x76, 4},
	{0x77, 4},
	{0x78, 2},
	{0x79, 2},
	{0x7A, 4},
	{0x7B, 2},
	{0x7C, 2},
	{0x7D, 2},
	{0x7E, 2},
	{0x7F, 2},
	{0x80, 2},
	{0x81, 2},
	{0x82, 4},
	{0x83, 0},
	{0x84, 4},
	{0x85, 0},
	{0x86, 4},
	{0x87, 4},
	{0x88, 2},
	{0x89, 2},
	{0x8A, 4},
	{0x8B, 0},
	{0x8C, 0},
	{0x8D, 2},
	{0x8E, 2},
	{0x8F, 2},
	{0x90, 2},
	{0x91, 2},
	{0x92, 4},
	{0x93, 0},
	{0x94, 4},
	{0x95, 0},
	{0x96, 4},
	{0x97, 4},
	{0x98, 2},
	{0x99, 2},
	{0x9A, 4},
	{0x9B, 2},
	{0x9C, 2},
	{0x9D, 2},
	{0x9E, 2},
	{0x9F, 2},
	{0xA0, 2},
	{0xA1, 2},
	{0xA2, 4},
	{0xA3, 0},
	{0xA4, 4},
	{0xA5, 4},
	{0xA6, 4},
	{0xA7, 4},
	{0xA8, 2},
	{0xA9, 2},
	{0xAA, 4},
	{0xAB, 2},
	{0xAC, 2},
	{0xAD, 2},
	{0xAE, 2},
	{0xAF, 2},
	{0xB0, 2},
	{0xB1, 2},
	{0xB2, 4},
	{0xB3, 0},
	{0xB4, 4},
	{0xB5, 4},
	{0xB6, 4},
	{0xB7, 4},
	{0xB8, 2},
	{0xB9, 2},
	{0xBA, 4},
	{0xBB, 2},
	{0xBC, 2},
	{0xBD, 2},
	{0xBE, 2},
	{0xBF, 2},
	{0xC0, 2},
	{0xC1, 0},
	{0xC2, 4},
	{0xC3, 0},
	{0xC4, 4},
	{0xC5, 4},
	{0xC6, 4},
	{0xC7, 0},
	{0xC8, 2},
	{0xC9, 2},
	{0xCA, 4},
	{0xCB, 2},
	{0xCC, 2},
	{0xCD, 2},
	{0xCE, 2},
	{0xCF, 2},
	{0xD0, 2},
	{0xD1, 2},
	{0xD2, 4},
	{0xD3, 0},
	{0xD4, 4},
	{0xD5, 4},
	{0xD6, 4},
	{0xD7, 4},
	{0xD8, 2},
	{0xD9, 2},
	{0xDA, 4},
	{0xDB, 2},
	{0xDC, 2},
	{0xDD, 2},
	{0xDE, 2},
	{0xDF, 2},
	{0xE0, 2},
	{0xE1, 2},
	{0xE2, 4},
	{0xE3, 0},
	{0xE4, 4},
	{0xE5, 0},
	{0xE6, 4},
	{0xE7, 4},
	{0xE8, 2},
	{0xE9, 2},
	{0xEA, 4},
	{0xEB, 2},
	{0xEC, 2},
	{0xED, 2},
	{0xEE, 2},
	{0xEF, 2},
	{0xF0, 2},
	{0xF1, 2},
	{0xF2, 4},
	{0xF3, 4},
	{0xF4, 4},
	{0xF5, 0},
	{0xF6, 4},
	{0xF7, 4},
	{0xF8, 0},
	{0xF9, 0},
	{0xFA, 4},
	{0xFB, 2},
	{0xFC, 2},
	{0xFD, 2},
	{0xFE, 2},
	{0xFF, 2},
};


static int disassemble(RzAsm *a, RzAsmOp *op, const ut8 *buf, int len) {
	struct c166_cmd cmd;
	cmd.esfr = false; // TODO: Depends on ext instr, how can this be set?
	int ret = c166_decode_command(buf, &cmd, len);
	rz_strbuf_set(&op->buf_asm, sdb_fmt("%s %s", cmd.instr, cmd.operands));
	if (ret > 0) {
		rz_warn_if_fail(ret == c166_opcode_sizes[buf[0]].len);
	}
	return op->size = ret;
}

RzAsmPlugin rz_asm_plugin_c166 = {
	.name = "c166",
	.license = "LGPL3",
	.desc = "Bosch/Siemens C166 disassembly plugin",
	.arch = "c166",
	.bits = 16,
	.endian = RZ_SYS_ENDIAN_LITTLE,
	.disassemble = &disassemble,
	.cpus = "c167cr"
};

#ifndef RZ_PLUGIN_INCORE
RZ_API RzLibStruct rizin_plugin = {
	.type = RZ_LIB_TYPE_ASM,
	.data = &rz_asm_plugin_c166,
	.version = RZ_VERSION
};
#endif
